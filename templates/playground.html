{% extends "base.html" %}

{% block title %}Playground | {{ config.title }}{% endblock %}
{% block description %}Interactive Sentinel configuration playground - validate configs, simulate requests, and visualize routing decisions{% endblock %}

{% block content %}
<section class="playground-hero">
    <div class="container">
        <h1 class="playground-title">
            <span class="gradient-text">Playground</span>
        </h1>
        <p class="playground-subtitle">
            Validate configurations, simulate requests, and visualize how Sentinel routes traffic
        </p>
    </div>
</section>

<section class="playground-main">
    <div class="container">
        <p class="playground-intro">Choose a template to get started, or write your own configuration below</p>

        <!-- Template Selector -->
        <div class="template-selector">
            <div class="template-grid">
                <button type="button" class="template-card" data-template="basic">
                    <h3>Vanilla Setup</h3>
                    <span class="template-tooltip">Simple reverse proxy with multiple routes and load balancing</span>
                </button>
                <button type="button" class="template-card" data-template="ai-gateway">
                    <h3>AI Gateway</h3>
                    <span class="template-tooltip">LLM inference proxy with token-based rate limiting and intelligent routing</span>
                </button>
                <button type="button" class="template-card" data-template="api-gateway">
                    <h3>API Gateway</h3>
                    <span class="template-tooltip">REST API proxy with schema validation and versioning</span>
                </button>
                <button type="button" class="template-card" data-template="microservices">
                    <h3>Service Mesh</h3>
                    <span class="template-tooltip">Service-to-service routing with health checks and load balancing</span>
                </button>
                <button type="button" class="template-card" data-template="static-cdn">
                    <h3>Varnish-type Caching (CDN)</h3>
                    <span class="template-tooltip">High-performance static file delivery with caching</span>
                </button>
                <button type="button" class="template-card" data-template="websocket">
                    <h3>WebSocket Proxy</h3>
                    <span class="template-tooltip">Real-time WebSocket connections with upgrade handling</span>
                </button>
                <button type="button" class="template-card" data-template="security">
                    <h3>Security Gateway</h3>
                    <span class="template-tooltip">WAF, rate limiting, and security headers</span>
                </button>
                <button type="button" class="template-card" data-template="canary">
                    <h3>Canary Deployment</h3>
                    <span class="template-tooltip">Gradual rollout with weighted traffic splitting between versions</span>
                </button>
                <button type="button" class="template-card" data-template="content-routing">
                    <h3>Content Router</h3>
                    <span class="template-tooltip">Header-based and path-based intelligent routing</span>
                </button>
                <button type="button" class="template-card" data-template="grpc">
                    <h3>gRPC Gateway</h3>
                    <span class="template-tooltip">HTTP/2 gRPC service proxy with load balancing</span>
                </button>
                <button type="button" class="template-card" data-template="multi-region">
                    <h3>Multi-Region</h3>
                    <span class="template-tooltip">Geographic routing with failover across regions</span>
                </button>
            </div>
        </div>

        <div class="playground-grid">
            <!-- Config Editor -->
            <div class="playground-panel config-panel" id="config-panel">
                <div class="panel-header">
                    <h2>Configuration</h2>
                    <div class="panel-header-actions">
                        <div class="validation-status" id="validation-status">
                            <span class="status-icon" id="status-icon"></span>
                            <span class="status-text" id="status-text">Loading...</span>
                        </div>
                        <button type="button" class="panel-action-btn" id="copy-config-btn" title="Copy configuration">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </button>
                        <button type="button" class="panel-action-btn" id="fullscreen-config-btn" title="Toggle fullscreen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-expand"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-collapse"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
                        </button>
                    </div>
                </div>
                <div class="editor-wrapper">
                    <div class="editor-container">
                        <pre class="editor-highlight" id="editor-highlight" aria-hidden="true"><code id="highlight-code"></code></pre>
                        <textarea id="config-editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off">system {
    worker-threads 4
    max-connections 10000
}

listeners {
    listener "http" {
        address "0.0.0.0:8080"
        protocol "http"
    }
}

routes {
    route "api" {
        priority "high"
        matches {
            path-prefix "/api"
        }
        upstream "backend"
        policies {
            timeout-secs 30
            failure-mode "open"
        }
    }
    route "static" {
        priority "medium"
        matches {
            path-prefix "/static"
        }
        upstream "backend"
    }
    route "default" {
        priority "low"
        matches {
            path-prefix "/"
        }
        upstream "backend"
    }
}

upstreams {
    upstream "backend" {
        target "127.0.0.1:8081" weight=1
        target "127.0.0.1:8082" weight=2
        load-balancing "round_robin"
    }
}</textarea>
                    </div>
                </div>
                <div class="error-display" id="error-display"></div>
            </div>

            <!-- Request Builder -->
            <div class="playground-panel request-panel">
                <div class="panel-header">
                    <h2>Request</h2>
                    <div class="request-tabs">
                        <button type="button" class="request-tab active" data-tab="builder">Builder</button>
                        <button type="button" class="request-tab" data-tab="raw">Raw</button>
                        <button type="button" class="request-tab" data-tab="agents">Agents</button>
                    </div>
                </div>

                <!-- Builder Tab (default) -->
                <div class="request-tab-content active" id="tab-builder">
                    <div class="request-builder">
                        <div class="request-row">
                            <label for="request-method">Method</label>
                            <select id="request-method">
                                <option value="GET" selected>GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                                <option value="HEAD">HEAD</option>
                                <option value="OPTIONS">OPTIONS</option>
                            </select>
                        </div>
                        <div class="request-row">
                            <label for="request-host">Host</label>
                            <input type="text" id="request-host" value="example.com" placeholder="example.com">
                        </div>
                        <div class="request-row">
                            <label for="request-path">Path</label>
                            <input type="text" id="request-path" value="/api/users" placeholder="/api/users">
                        </div>
                        <div class="request-row headers-row">
                            <label>Headers</label>
                            <div class="headers-list" id="headers-list">
                                <!-- Headers added dynamically -->
                            </div>
                            <button type="button" class="btn btn-ghost btn-small" id="add-header-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Add Header
                            </button>
                        </div>
                        <button type="button" class="btn btn-gradient simulate-btn" id="simulate-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Simulate Request
                        </button>
                    </div>
                </div>

                <!-- Raw Tab -->
                <div class="request-tab-content" id="tab-raw">
                    <div class="request-raw">
                        <textarea id="raw-request" spellcheck="false" placeholder="GET /api/users HTTP/1.1
Host: example.com
Content-Type: application/json
Authorization: Bearer token123">GET /api/users HTTP/1.1
Host: example.com</textarea>
                        <button type="button" class="btn btn-gradient simulate-btn" id="simulate-raw-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Simulate Request
                        </button>
                    </div>
                </div>

                <!-- Agents Tab -->
                <div class="request-tab-content" id="tab-agents">
                    <div class="agents-builder">
                        <div class="agents-empty" id="agents-empty">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                            <p>No agents detected in configuration</p>
                            <p class="agents-hint">Add <code>agents</code> and <code>filters</code> blocks to your config to simulate agent decisions</p>
                        </div>
                        <div class="agents-list" id="agents-list">
                            <!-- Agent cards populated by JS -->
                        </div>
                        <button type="button" class="btn btn-gradient simulate-btn" id="simulate-agents-btn" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Simulate with Agents
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flow Diagram -->
        <div class="playground-panel flow-panel" id="flow-panel">
            <div class="panel-header">
                <h2>Request & Response Flow</h2>
            </div>
            <div class="flow-container">
                <div class="flow-section">
                    <h3 class="flow-section-title">Request Flow</h3>
                    <div class="flow-diagram" id="flow-diagram">
                        <div class="flow-placeholder">
                            <p>Click "Simulate Request" to see the routing flow</p>
                        </div>
                    </div>
                </div>
                <div class="flow-divider"></div>
                <div class="flow-section">
                    <h3 class="flow-section-title">Response Flow</h3>
                    <div class="flow-diagram" id="response-flow-diagram">
                        <div class="flow-placeholder">
                            <p>Response flow will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Trace -->
        <div class="playground-panel trace-panel" id="trace-panel">
            <div class="panel-header">
                <h2>Detailed Trace</h2>
                <button type="button" class="btn btn-ghost btn-small" id="toggle-trace-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    Expand All
                </button>
            </div>
            <div class="trace-content" id="trace-content">
                <div class="trace-placeholder">
                    <p>Simulation results will appear here</p>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="playground-info">
            <div class="info-badge">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-9"/><path d="M15.17 2.21a1.67 1.67 0 0 1 1.63 0L21 4.57a1.93 1.93 0 0 1 0 3.36L8.82 14.79a1.655 1.655 0 0 1-1.64 0L3 12.43a1.93 1.93 0 0 1 0-3.36z"/><path d="M20 13v3.87a2.06 2.06 0 0 1-1.11 1.83l-6 3.08a1.93 1.93 0 0 1-1.78 0l-6-3.08A2.06 2.06 0 0 1 4 16.87V13"/><path d="M21 12.43a1.93 1.93 0 0 0 0-3.36L8.83 2.2a1.64 1.64 0 0 0-1.63 0L3 4.57a1.93 1.93 0 0 0 0 3.36l12.18 6.86a1.636 1.636 0 0 0 1.63 0z"/></svg>
                <span>Powered by <a href="https://www.rust-lang.org/" target="_blank" rel="noopener">Rust</a> + <a href="https://webassembly.org/" target="_blank" rel="noopener">WebAssembly</a></span>
            </div>
            <div class="info-content">
                <h3>Real Engine, Real Results</h3>
                <p>This isn't a simulation &mdash; it's the <strong>actual Sentinel routing engine</strong> compiled to <a href="https://webassembly.org/" target="_blank" rel="noopener">WebAssembly</a> and running directly in your browser. The same <a href="https://www.rust-lang.org/" target="_blank" rel="noopener">Rust</a> code that powers production proxies is executing here: config parsing, route matching, load balancer selection, and policy evaluation.</p>
                <p class="info-highlight">Because Sentinel is written in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener">Rust</a>, we can compile the core engine to <a href="https://webassembly.org/" target="_blank" rel="noopener">WASM</a> with zero compromises &mdash; giving you an accurate, interactive preview of exactly how your configuration will behave.</p>
            </div>
            <div class="info-version-badge" id="version-badge">
                <button type="button" class="version-badge-btn" id="version-badge-btn" title="Click for local runtime options">
                    <span>Sentinel Version: <span id="wasm-version">Loading...</span></span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="version-dropdown" id="version-dropdown">
                    <div class="version-dropdown-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        <span>Run Locally</span>
                    </div>
                    <p class="version-dropdown-desc">Take the same engine home. Run configs locally with any WASI-compatible runtime.</p>
                    <div class="version-dropdown-actions">
                        <a href="/wasm/sentinel_playground_wasm_bg.wasm" download="sentinel_playground.wasm" class="btn btn-primary btn-small">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Download WASM
                            <span class="wasm-size">(~2.2 MB)</span>
                        </a>
                    </div>
                    <div class="version-dropdown-code">
                        <p class="code-label">Run with <a href="https://wasmtime.dev/" target="_blank" rel="noopener">Wasmtime</a>:</p>
                        <pre><code><span class="code-comment"># Install wasmtime</span>
curl https://wasmtime.dev/install.sh -sSf | bash

<span class="code-comment"># Validate a config file</span>
wasmtime sentinel_playground.wasm validate config.kdl

<span class="code-comment"># Simulate a request</span>
wasmtime sentinel_playground.wasm simulate config.kdl \
  --method GET --path /api/users --host example.com</code></pre>
                    </div>
                    <div class="version-dropdown-runtimes">
                        <span class="runtimes-label">Also works with:</span>
                        <a href="https://wasmer.io/" target="_blank" rel="noopener">Wasmer</a>
                        <span class="separator">·</span>
                        <a href="https://wazero.io/" target="_blank" rel="noopener">wazero</a>
                        <span class="separator">·</span>
                        <a href="https://github.com/aspect-build/rules_esbuild" target="_blank" rel="noopener">Node.js</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ get_url(path='js/playground.js') | safe }}"></script>
{% endblock %}
