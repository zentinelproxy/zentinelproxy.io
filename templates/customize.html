{% extends "base.html" %}

{% block title %}{{ page.title }} | {{ config.title }}{% endblock %}

{% block content %}
<section class="customize-page">
    <div class="container">
        <header class="customize-header">
            <h1>{{ page.title }}</h1>
            <p class="customize-subtitle">Build your bespoke Sentinel installation. {{ page.description }}</p>
        </header>

        <div class="customize-content">
            <!-- Installation Method -->
            <div class="customize-section">
                <h2>
                    <span class="section-number">1</span>
                    Installation Method
                </h2>
                <div class="option-cards">
                    <label class="option-card selected" data-method="cargo">
                        <input type="radio" name="install-method" value="cargo" checked>
                        <div class="option-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16">
                                <g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linejoin="round" stroke-width="1">
                                    <path stroke-linecap="round" d="M1.5 7L8 10.5L14.5 7m-10-2.5l3.503 2L14.498 3M4.5 5.5v7m3.5-6V14"/>
                                    <path stroke-linecap="round" d="M8.003 3L11.5 4.5v8"/>
                                    <path stroke-linecap="square" d="M1.5 6.984V11l6.503 3.5L14.5 11V3L11 1.5l-6.5 3v1z"/>
                                </g>
                            </svg>
                        </div>
                        <div class="option-content">
                            <h3>Cargo</h3>
                            <p>Install from crates.io using Rust's package manager</p>
                        </div>
                        <div class="option-check">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </div>
                    </label>
                    <label class="option-card disabled" data-method="oci">
                        <input type="radio" name="install-method" value="oci" disabled>
                        <div class="option-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M13.152.682a2.25 2.25 0 0 1 2.269 0l.007.004l6.957 4.276a2.28 2.28 0 0 1 1.126 1.964v7.516c0 .81-.432 1.56-1.133 1.968l-.002.001l-11.964 7.037l-.004.003c-.706.41-1.578.41-2.284 0l-.026-.015l-6.503-4.502a2.27 2.27 0 0 1-1.096-1.943V9.438c0-.392.1-.77.284-1.1l.003-.006l.014-.026c.197-.342.48-.627.82-.827h.002L13.152.681Zm.757 1.295h-.001L2.648 8.616l6.248 4.247a.78.78 0 0 0 .758-.01h.001l11.633-6.804l-6.629-4.074a.75.75 0 0 0-.75.003ZM8.517 14.33a2.3 2.3 0 0 1-.393-.18l-.023-.014l-6.102-4.147v7.003c0 .275.145.528.379.664l.025.014l6.114 4.232zM18 9.709l-3.25 1.9v7.548L18 17.245Zm-7.59 4.438l-.002.002a2.3 2.3 0 0 1-.391.18v7.612l3.233-1.902v-7.552Zm9.09-5.316v7.532l2.124-1.25a.78.78 0 0 0 .387-.671V7.363Z"/>
                            </svg>
                        </div>
                        <div class="option-content">
                            <h3>OCI Container</h3>
                            <p>Pull pre-built container image</p>
                            <span class="coming-soon-badge">Coming Soon</span>
                        </div>
                        <div class="option-check">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Agent Selection -->
            <div class="customize-section">
                <h2>
                    <span class="section-number">2</span>
                    Official Agents
                </h2>
                <p class="section-description">Select the agents you want to include. All agents are optional and can be added later.</p>

                <div class="agents-grid">
                    <!-- Stable Agents -->
                    <label class="agent-card" data-agent="auth" data-crate="sentinel-agent-auth">
                        <input type="checkbox" name="agents" value="auth">
                        <div class="agent-header">
                            <div class="agent-info">
                                <h3>Auth</h3>
                                <span class="status-badge stable">Stable</span>
                            </div>
                            <div class="agent-check">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        </div>
                        <p class="agent-description">Authentication and authorization with JWT, API keys, OAuth support</p>
                    </label>

                    <label class="agent-card" data-agent="ratelimit" data-crate="sentinel-agent-ratelimit">
                        <input type="checkbox" name="agents" value="ratelimit">
                        <div class="agent-header">
                            <div class="agent-info">
                                <h3>Rate Limiter</h3>
                                <span class="status-badge stable">Stable</span>
                            </div>
                            <div class="agent-check">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        </div>
                        <p class="agent-description">Token bucket rate limiting with configurable windows and limits</p>
                    </label>

                    <label class="agent-card" data-agent="denylist" data-crate="sentinel-agent-denylist">
                        <input type="checkbox" name="agents" value="denylist">
                        <div class="agent-header">
                            <div class="agent-info">
                                <h3>Denylist</h3>
                                <span class="status-badge stable">Stable</span>
                            </div>
                            <div class="agent-check">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        </div>
                        <p class="agent-description">Block requests based on IP addresses, CIDR ranges, or patterns</p>
                    </label>

                    <!-- Beta Agents -->
                    <label class="agent-card" data-agent="waf" data-crate="sentinel-agent-waf">
                        <input type="checkbox" name="agents" value="waf">
                        <div class="agent-header">
                            <div class="agent-info">
                                <h3>WAF</h3>
                                <span class="status-badge beta">Beta</span>
                            </div>
                            <div class="agent-check">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        </div>
                        <p class="agent-description">OWASP CRS-compatible web application firewall</p>
                    </label>

                    <label class="agent-card" data-agent="lua" data-crate="sentinel-agent-lua">
                        <input type="checkbox" name="agents" value="lua">
                        <div class="agent-header">
                            <div class="agent-info">
                                <h3>Lua Scripting</h3>
                                <span class="status-badge beta">Beta</span>
                            </div>
                            <div class="agent-check">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                        </div>
                        <p class="agent-description">Embed custom Lua scripts for flexible request/response processing</p>
                    </label>
                </div>
            </div>

            <!-- Installation Commands -->
            <div class="customize-section">
                <h2>
                    <span class="section-number">3</span>
                    Installation
                </h2>
                <div class="code-output">
                    <div class="code-header">
                        <span class="code-label">Shell</span>
                        <button class="copy-btn" onclick="copyCode('install-code')" aria-label="Copy to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            <span>Copy</span>
                        </button>
                    </div>
                    <pre id="install-code"><code># Install Sentinel
cargo install sentinel-proxy

# No agents selected yet</code></pre>
                </div>
            </div>

            <!-- Example Configuration -->
            <div class="customize-section">
                <h2>
                    <span class="section-number">4</span>
                    Example Configuration
                </h2>
                <p class="section-description">A starter configuration with your selected agents. Save as <code>sentinel.kdl</code></p>
                <div class="code-output">
                    <div class="code-header">
                        <span class="code-label">sentinel.kdl</span>
                        <button class="copy-btn" onclick="copyCode('config-code')" aria-label="Copy to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            <span>Copy</span>
                        </button>
                    </div>
                    <pre id="config-code"><code>// Sentinel Configuration
// https://sentinel.raskell.io

server {
    worker-threads 0  // 0 = number of CPU cores
    graceful-shutdown-timeout-secs 30
}

listeners {
    listener "http" {
        address "0.0.0.0:8080"
        protocol "http"
    }
}

routes {
    route "default" {
        matches {
            path-prefix "/"
        }
        upstream "backend"
    }
}

upstreams {
    upstream "backend" {
        targets {
            target {
                address "127.0.0.1:3000"
            }
        }
        load-balancing "round_robin"
    }
}

// No agents configured</code></pre>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="customize-section next-steps">
                <h2>
                    <span class="section-number">5</span>
                    Next Steps
                </h2>
                <div class="next-steps-grid">
                    <a href="{{ config.extra.docs_external_url }}" class="next-step-card">
                        <div class="next-step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        </div>
                        <h3>Read the Docs</h3>
                        <p>Learn about configuration, routing, and advanced features</p>
                    </a>
                    <a href="/agents/" class="next-step-card">
                        <div class="next-step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 14h3M1 9h3M1 14h3"/></svg>
                        </div>
                        <h3>Explore Agents</h3>
                        <p>Discover all available agents and their capabilities</p>
                    </a>
                    <a href="{{ config.extra.github }}" class="next-step-card">
                        <div class="next-step-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        </div>
                        <h3>Star on GitHub</h3>
                        <p>Follow development and contribute to the project</p>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Agent configuration data
const agentConfigs = {
    auth: {
        crate: 'sentinel-agent-auth',
        config: `agent "auth" {
        type "auth"
        transport "unix_socket" {
            path "/var/run/sentinel/auth.sock"
        }
        events ["request_headers"]
        timeout-ms 100
        failure-mode "closed"
    }`
    },
    ratelimit: {
        crate: 'sentinel-agent-ratelimit',
        config: `agent "ratelimit" {
        type "rate_limit"
        transport "unix_socket" {
            path "/var/run/sentinel/ratelimit.sock"
        }
        events ["request_headers"]
        timeout-ms 50
        failure-mode "open"
    }`
    },
    denylist: {
        crate: 'sentinel-agent-denylist',
        config: `agent "denylist" {
        type "denylist"
        transport "unix_socket" {
            path "/var/run/sentinel/denylist.sock"
        }
        events ["request_headers"]
        timeout-ms 50
        failure-mode "open"
    }`
    },
    waf: {
        crate: 'sentinel-agent-waf',
        config: `agent "waf" {
        type "waf"
        transport "unix_socket" {
            path "/var/run/sentinel/waf.sock"
        }
        events ["request_headers" "request_body"]
        timeout-ms 200
        failure-mode "closed"
        max-request-body-bytes 1048576
    }`
    },
    lua: {
        crate: 'sentinel-agent-lua',
        config: `agent "lua" {
        type "lua"
        transport "unix_socket" {
            path "/var/run/sentinel/lua.sock"
        }
        events ["request_headers" "response_headers"]
        timeout-ms 100
        failure-mode "open"
    }`
    }
};

// Update installation and config when selections change
function updateOutput() {
    const selectedAgents = Array.from(document.querySelectorAll('input[name="agents"]:checked'))
        .map(cb => cb.value);

    // Update install commands
    let installCode = `# Install Sentinel
cargo install sentinel-proxy
`;

    if (selectedAgents.length > 0) {
        installCode += `
# Install selected agents
`;
        selectedAgents.forEach(agent => {
            installCode += `cargo install ${agentConfigs[agent].crate}
`;
        });
    } else {
        installCode += `
# No agents selected yet`;
    }

    document.querySelector('#install-code code').textContent = installCode;

    // Update config
    let configCode = `// Sentinel Configuration
// https://sentinel.raskell.io

server {
    worker-threads 0  // 0 = number of CPU cores
    graceful-shutdown-timeout-secs 30
}

listeners {
    listener "http" {
        address "0.0.0.0:8080"
        protocol "http"
    }
}

routes {
    route "default" {
        matches {
            path-prefix "/"
        }
        upstream "backend"`;

    if (selectedAgents.length > 0) {
        configCode += `\n        agents [${selectedAgents.map(a => `"${a}"`).join(' ')}]`;
    }

    configCode += `
    }
}

upstreams {
    upstream "backend" {
        targets {
            target {
                address "127.0.0.1:3000"
            }
        }
        load-balancing "round_robin"
    }
}`;

    if (selectedAgents.length > 0) {
        configCode += '\n\nagents {';
        selectedAgents.forEach(agent => {
            configCode += '\n    ' + agentConfigs[agent].config;
        });
        configCode += '\n}';
    } else {
        configCode += '\n\n// No agents configured';
    }

    document.querySelector('#config-code code').textContent = configCode;
}

// Copy code to clipboard
function copyCode(elementId) {
    const code = document.querySelector(`#${elementId} code`).textContent;
    navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector(`#${elementId}`).parentElement.querySelector('.copy-btn span');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
    });
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', () => {
    // Installation method selection
    document.querySelectorAll('input[name="install-method"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            document.querySelectorAll('.option-card[data-method]').forEach(card => {
                card.classList.toggle('selected', card.dataset.method === e.target.value);
            });
            updateOutput();
        });
    });

    // Agent selection
    document.querySelectorAll('input[name="agents"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            e.target.closest('.agent-card').classList.toggle('selected', e.target.checked);
            updateOutput();
        });
    });

    // Initial output
    updateOutput();
});
</script>
{% endblock %}
